@model CollectionApp.Application.ViewModels.PaymentCreateVM
@{
    ViewData["Title"] = "Create Payment";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-controller="Payment" asp-action="Index">Payments</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Create Payment</li>
                </ol>
            </nav>

            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-plus me-2"></i>Create New Payment
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to List
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <form asp-action="Create" method="post" id="paymentForm">
                        <div class="row">
                            <!-- Contract and Installment Selection -->
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-file-contract me-2"></i>Contract & Installment</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="ContractId" class="form-label">Contract *</label>
                                            <select asp-for="ContractId" class="form-select" id="contractSelect" required>
                                                <option value="">Select a contract...</option>
                                            </select>
                                            <span asp-validation-for="ContractId" class="text-danger"></span>
                                            <div class="form-text">Select the contract for this payment</div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="InstallmentId" class="form-label">Installment *</label>
                                            <select asp-for="InstallmentId" class="form-select" id="installmentSelect" required disabled>
                                                <option value="">Select an installment...</option>
                                            </select>
                                            <span asp-validation-for="InstallmentId" class="text-danger"></span>
                                            <div class="form-text">Select the installment to pay</div>
                                        </div>

                                        <div id="installmentDetails" class="alert alert-info" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Due Date:</strong> <span id="dueDate"></span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Amount Due:</strong> <span id="amountDue"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Details -->
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label asp-for="Amount" class="form-label">Payment Amount *</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input asp-for="Amount" class="form-control" type="number" step="0.01" min="0.01" 
                                                       id="paymentAmount" required />
                                                <select asp-for="Currency" class="form-select" style="max-width: 100px;">
                                                    <option value="USD">USD</option>
                                                    <option value="EUR">EUR</option>
                                                    <option value="GBP">GBP</option>
                                                    <option value="JPY">JPY</option>
                                                </select>
                                            </div>
                                            <span asp-validation-for="Amount" class="text-danger"></span>
                                            <div class="form-text">Enter the payment amount</div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="PaymentDate" class="form-label">Payment Date *</label>
                                            <input asp-for="PaymentDate" class="form-control" type="date" required />
                                            <span asp-validation-for="PaymentDate" class="text-danger"></span>
                                            <div class="form-text">Date when the payment was received</div>
                                        </div>

                                        <div class="mb-3">
                                            <label asp-for="PaymentMethod" class="form-label">Payment Method *</label>
                                            <select asp-for="PaymentMethod" class="form-select" required>
                                                <option value="">Select payment method...</option>
                                                <option value="Cash">Cash</option>
                                                <option value="BankTransfer">Bank Transfer</option>
                                                <option value="CreditCard">Credit Card</option>
                                                <option value="DebitCard">Debit Card</option>
                                                <option value="Check">Check</option>
                                                <option value="MobilePayment">Mobile Payment</option>
                                                <option value="Other">Other</option>
                                            </select>
                                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="ReferenceNumber" class="form-label">Reference Number</label>
                                                    <input asp-for="ReferenceNumber" class="form-control" 
                                                           placeholder="e.g., Check number, transaction ID" />
                                                    <span asp-validation-for="ReferenceNumber" class="text-danger"></span>
                                                    <div class="form-text">Optional reference number for tracking</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="ProcessedByStaffId" class="form-label">Processed By</label>
                                                    <select asp-for="ProcessedByStaffId" class="form-select" id="staffSelect">
                                                        <option value="">Select staff member...</option>
                                                    </select>
                                                    <span asp-validation-for="ProcessedByStaffId" class="text-danger"></span>
                                                    <div class="form-text">Staff member who processed this payment</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label asp-for="Notes" class="form-label">Notes</label>
                                            <textarea asp-for="Notes" class="form-control" rows="3" 
                                                      placeholder="Additional notes about this payment..."></textarea>
                                            <span asp-validation-for="Notes" class="text-danger"></span>
                                            <div class="form-text">Optional notes about the payment</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a asp-action="Index" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-save me-1"></i>Process Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load contracts on page load
            loadContracts();
            loadStaffMembers();

            // Contract selection change
            $('#contractSelect').change(function() {
                const contractId = $(this).val();
                if (contractId) {
                    loadInstallments(contractId);
                } else {
                    $('#installmentSelect').html('<option value="">Select an installment...</option>').prop('disabled', true);
                    $('#installmentDetails').hide();
                }
            });

            // Installment selection change
            $('#installmentSelect').change(function() {
                const installmentId = $(this).val();
                if (installmentId) {
                    loadInstallmentDetails(installmentId);
                } else {
                    $('#installmentDetails').hide();
                }
            });

            // Amount validation
            $('#paymentAmount').on('input', function() {
                validatePaymentAmount();
            });

            // Form submission
            $('#paymentForm').submit(function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return false;
                }
                
                // Disable submit button to prevent double submission
                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Processing...');
            });
        });

        function loadContracts() {
            $.get('/api/contracts', function(contracts) {
                const select = $('#contractSelect');
                select.find('option:not(:first)').remove();
                
                // Handle both paged and non-paged responses
                const contractsData = contracts.items || contracts.data || contracts;
                
                contractsData.forEach(function(contract) {
                    select.append(`<option value="${contract.id}">${contract.contractNumber} - ${contract.customerName}</option>`);
                });
            }).fail(function() {
                showAlert('Error loading contracts', 'danger');
            });
        }

        function loadInstallments(contractId) {
            $.get(`/api/contracts/${contractId}/installments`, function(installments) {
                const select = $('#installmentSelect');
                select.html('<option value="">Select an installment...</option>').prop('disabled', false);
                
                // Handle both paged and non-paged responses
                const installmentsData = installments.items || installments.data || installments;
                
                installmentsData.forEach(function(installment) {
                    if (installment.status !== 'Paid') {
                        select.append(`<option value="${installment.id}" data-amount="${installment.amount}" data-due-date="${installment.dueDate}">
                            Installment #${installment.installmentNumber} - ${installment.amount} ${installment.currency}
                        </option>`);
                    }
                });
            }).fail(function() {
                showAlert('Error loading installments', 'danger');
            });
        }

        function loadInstallmentDetails(installmentId) {
            const selectedOption = $(`#installmentSelect option[value="${installmentId}"]`);
            const amount = selectedOption.data('amount');
            const dueDate = selectedOption.data('due-date');
            
            $('#amountDue').text(amount);
            $('#dueDate').text(new Date(dueDate).toLocaleDateString());
            $('#installmentDetails').show();
            
            // Set payment amount to installment amount by default
            $('#paymentAmount').val(amount);
        }

        function loadStaffMembers() {
            $.get('/api/staff', function(staff) {
                const select = $('#staffSelect');
                select.find('option:not(:first)').remove();
                
                staff.data.forEach(function(member) {
                    select.append(`<option value="${member.id}">${member.name}</option>`);
                });
            }).fail(function() {
                // Staff loading failure is not critical
                console.log('Could not load staff members');
            });
        }

        function validatePaymentAmount() {
            const amount = parseFloat($('#paymentAmount').val());
            const installmentAmount = parseFloat($('#installmentSelect option:selected').data('amount') || 0);
            
            if (amount > installmentAmount) {
                $('#paymentAmount').addClass('is-invalid');
                $('<div class="invalid-feedback">Payment amount cannot exceed installment amount</div>').insertAfter('#paymentAmount');
            } else {
                $('#paymentAmount').removeClass('is-invalid');
                $('#paymentAmount').next('.invalid-feedback').remove();
            }
        }

        function validateForm() {
            let isValid = true;
            
            // Basic validation
            if (!$('#contractSelect').val()) {
                showAlert('Please select a contract', 'warning');
                isValid = false;
            }
            
            if (!$('#installmentSelect').val()) {
                showAlert('Please select an installment', 'warning');
                isValid = false;
            }
            
            if (!$('#paymentAmount').val() || parseFloat($('#paymentAmount').val()) <= 0) {
                showAlert('Please enter a valid payment amount', 'warning');
                isValid = false;
            }
            
            if (!$('#paymentDate').val()) {
                showAlert('Please select a payment date', 'warning');
                isValid = false;
            }
            
            if (!$('#paymentMethod').val()) {
                showAlert('Please select a payment method', 'warning');
                isValid = false;
            }
            
            return isValid;
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            $('.card-body').prepend(alertHtml);
            
            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/Payment/PaymentOperations.css" />
} 