@model Tracker_Money.Models.PagedViewModel<CollectionApp.Application.ViewModels.PaymentListVM>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>
                    <a href="#" onclick="sortPayments('PaymentDate')" class="text-white text-decoration-none">
                        Payment Date
                        @if (Model.OrderBy == "PaymentDate")
                        {
                            <i class="fas fa-sort-alpha-down ms-1"></i>
                        }
                    </a>
                </th>
                <th>
                    <a href="#" onclick="sortPayments('ContractNumber')" class="text-white text-decoration-none">
                        Contract Number
                        @if (Model.OrderBy == "ContractNumber")
                        {
                            <i class="fas fa-sort-alpha-down ms-1"></i>
                        }
                    </a>
                </th>
                <th>Customer Name</th>
                <th>Installment</th>
                <th>
                    <a href="#" onclick="sortPayments('Amount')" class="text-white text-decoration-none">
                        Amount
                        @if (Model.OrderBy == "Amount")
                        {
                            <i class="fas fa-sort-alpha-down ms-1"></i>
                        }
                    </a>
                </th>
                <th>Payment Method</th>
                <th>Reference</th>
                <th>Staff</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Items.Any())
            {
                @foreach (var payment in Model.Items)
                {
                    <tr>
                        <td>
                            <span class="text-muted">@payment.PaymentDate.ToString("MMM dd, yyyy")</span>
                        </td>
                        <td>
                            <a asp-controller="Contract" asp-action="Details" asp-route-id="@payment.ContractId" 
                               class="text-decoration-none">
                                @payment.ContractNumber
                            </a>
                        </td>
                        <td>
                            <span class="fw-medium">@payment.CustomerName</span>
                        </td>
                        <td>
                            @if (payment.InstallmentNumber.HasValue)
                            {
                                <span class="badge bg-info">#@payment.InstallmentNumber</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <span class="fw-bold text-success">
                                @Tracker_Money.Helpers.CurrencyFormatter.FormatCurrency(payment.Amount, payment.Currency)
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-primary">@payment.PaymentMethod</span>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(payment.ReferenceNumber))
                            {
                                <span class="text-muted">@payment.ReferenceNumber</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <span class="text-muted">@payment.StaffName</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a asp-action="Details" asp-route-id="@payment.Id" 
                                   class="btn btn-outline-primary btn-sm" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@payment.Id" 
                                   class="btn btn-outline-secondary btn-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                        onclick="openReversePaymentModal('@payment.Id')" title="Reverse Payment">
                                    <i class="fas fa-undo"></i>
                                </button>
                                @if (!string.IsNullOrEmpty(payment.ReceiptNumber))
                                {
                                    <a asp-action="ViewReceipt" asp-route-id="@payment.Id" 
                                       class="btn btn-outline-info btn-sm" title="View Receipt">
                                        <i class="fas fa-receipt"></i>
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p class="mb-0">No payments found</p>
                            <small>Try adjusting your search criteria</small>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Pagination -->
@if (Model.TotalPages > 1)
{
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
            Showing @((Model.PageNumber - 1) * Model.PageSize + 1) to 
            @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount) of @Model.TotalCount payments
        </div>
        <partial name="_Pager" model="Model" />
    </div>
}

<script>
    function sortPayments(orderBy) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('orderBy', orderBy);
        currentUrl.searchParams.set('page', '1'); // Reset to first page when sorting
        
        // Load the sorted results via AJAX
        $.get(currentUrl.toString(), function(data) {
            $('#paymentSearchResults').html(data);
        });
    }

    function loadPaymentPage(page) {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('page', page);
        
        // Load the page results via AJAX
        $.get(currentUrl.toString(), function(data) {
            $('#paymentSearchResults').html(data);
        });
    }

    function searchPayments(searchTerm, page = 1) {
        const url = `/Payment/Search?searchTerm=${encodeURIComponent(searchTerm)}&page=${page}`;
        
        $.get(url, function(data) {
            $('#paymentSearchResults').html(data);
        });
    }

    // Function to open reverse payment modal
    function openReversePaymentModal(paymentId) {
        // Get payment details first
        $.get(`/api/payments/${paymentId}`, function(response) {
            if (response.success) {
                const payment = response.data;
                const paymentData = {
                    amount: payment.amount,
                    currency: payment.currency,
                    paymentDate: payment.paymentDate,
                    paymentMethod: payment.paymentMethod
                };
                
                // Show the modal with payment details using the global function
                PaymentOperations.showReversePaymentModal(paymentId, paymentData);
            } else {
                alert('Failed to load payment details');
            }
        }).fail(function() {
            alert('Error loading payment details');
        });
    }
</script> 