@model CollectionApp.Application.ViewModels.PaymentHistoryVM
@{
    ViewData["Title"] = "Payment History";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-controller="Payment" asp-action="Index">Payments</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Payment History</li>
                </ol>
            </nav>

            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-history me-2"></i>Payment History
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportHistory()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printHistory()">
                                    <i class="fas fa-print me-1"></i>Print
                                </button>
                                <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Back to List
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Options</h6>
                                </div>
                                <div class="card-body">
                                    <form method="get" id="filterForm">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Date Range</label>
                                                <div class="input-group">
                                                    <input type="date" class="form-control" name="fromDate" 
                                                           value="@ViewBag.FromDate?.ToString("yyyy-MM-dd")" />
                                                    <span class="input-group-text">to</span>
                                                    <input type="date" class="form-control" name="toDate" 
                                                           value="@ViewBag.ToDate?.ToString("yyyy-MM-dd")" />
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Contract ID</label>
                                                <input type="text" class="form-control" name="contractId" 
                                                       value="@ViewBag.ContractId" placeholder="Contract ID" />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Customer ID</label>
                                                <input type="text" class="form-control" name="customerId" 
                                                       value="@ViewBag.CustomerId" placeholder="Customer ID" />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Payment Method</label>
                                                <select class="form-select" name="paymentMethod">
                                                    <option value="">All Methods</option>
                                                    <option value="Cash">Cash</option>
                                                    <option value="BankTransfer">Bank Transfer</option>
                                                    <option value="CreditCard">Credit Card</option>
                                                    <option value="DebitCard">Debit Card</option>
                                                    <option value="Check">Check</option>
                                                    <option value="MobilePayment">Mobile Payment</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Quick Filters</label>
                                                <div class="d-grid gap-1">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-primary" onclick="setDateRange('today')">Today</button>
                                                        <button type="button" class="btn btn-outline-primary" onclick="setDateRange('week')">This Week</button>
                                                        <button type="button" class="btn btn-outline-primary" onclick="setDateRange('month')">This Month</button>
                                                        <button type="button" class="btn btn-outline-primary" onclick="setDateRange('year')">This Year</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12 text-end">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-search me-1"></i>Apply Filters
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                                    <i class="fas fa-times me-1"></i>Clear
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">@Model.PaymentCount</h4>
                                    <small>Total Payments</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">@Tracker_Money.Helpers.CurrencyFormatter.FormatCurrency(Model.TotalAmount, Model.Currency)</h4>
                                    <small>Total Amount</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">@(Model.PaymentCount > 0 ? Tracker_Money.Helpers.CurrencyFormatter.FormatCurrency(Model.TotalAmount / Model.PaymentCount, Model.Currency) : Tracker_Money.Helpers.CurrencyFormatter.FormatCurrency(0, Model.Currency))</h4>
                                    <small>Average Payment</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">@Model.Currency</h4>
                                    <small>Currency</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment History Table -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Payment History</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Payment Date</th>
                                            <th>Contract Number</th>
                                            <th>Customer Name</th>
                                            <th>Installment</th>
                                            <th>Amount</th>
                                            <th>Payment Method</th>
                                            <th>Reference</th>
                                            <th>Staff</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.Payments.Any())
                                        {
                                            @foreach (var payment in Model.Payments)
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="text-muted">@payment.PaymentDate.ToString("MMM dd, yyyy")</span>
                                                    </td>
                                                    <td>
                                                        <a asp-controller="Contract" asp-action="Details" asp-route-id="@payment.ContractId" 
                                                           class="text-decoration-none">
                                                            @payment.ContractNumber
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <span class="fw-medium">@payment.CustomerName</span>
                                                    </td>
                                                    <td>
                                                        @if (payment.InstallmentNumber.HasValue)
                                                        {
                                                            <span class="badge bg-info">#@payment.InstallmentNumber</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                                                    <span class="fw-bold text-success">
                                @Tracker_Money.Helpers.CurrencyFormatter.FormatCurrency(payment.Amount, payment.Currency)
                            </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">@payment.PaymentMethod</span>
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(payment.ReferenceNumber))
                                                        {
                                                            <span class="text-muted">@payment.ReferenceNumber</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <span class="text-muted">@payment.StaffName</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <a asp-action="Details" asp-route-id="@payment.Id" 
                                                               class="btn btn-outline-primary btn-sm" title="View Details">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            <a asp-action="ViewReceipt" asp-route-id="@payment.Id" 
                                                               class="btn btn-outline-info btn-sm" title="View Receipt">
                                                                <i class="fas fa-receipt"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="9" class="text-center py-4">
                                                    <div class="text-muted">
                                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                                        <p class="mb-0">No payment history found</p>
                                                        <small>Try adjusting your filter criteria</small>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function setDateRange(range) {
            const today = new Date();
            let fromDate = new Date();
            let toDate = new Date();

            switch (range) {
                case 'today':
                    fromDate = today;
                    toDate = today;
                    break;
                case 'week':
                    fromDate.setDate(today.getDate() - today.getDay());
                    toDate = today;
                    break;
                case 'month':
                    fromDate.setDate(1);
                    toDate = today;
                    break;
                case 'year':
                    fromDate.setFullYear(today.getFullYear(), 0, 1);
                    toDate = today;
                    break;
            }

            document.querySelector('input[name="fromDate"]').value = fromDate.toISOString().split('T')[0];
            document.querySelector('input[name="toDate"]').value = toDate.toISOString().split('T')[0];
        }

        function clearFilters() {
            document.getElementById('filterForm').reset();
        }

        function exportHistory() {
            // Implementation for exporting payment history
            alert('Export functionality will be implemented here');
        }

        function printHistory() {
            window.print();
        }

        // Auto-hide success/error messages after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/Payment/History.css" />
    
    <style>
        @media print {
            .btn, .breadcrumb, .card-header {
                display: none !important;
            }
            
            .card {
                border: none !important;
                box-shadow: none !important;
            }
            
            .card-body {
                padding: 0 !important;
            }
        }
    </style>
} 